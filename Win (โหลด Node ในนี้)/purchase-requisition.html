<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จัดทำใบขอซื้อ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="dashboard.css">
    <style>
        /* เพิ่มสไตล์เฉพาะสำหรับหน้าจัดทำใบขอซื้อ */
        .form-container {
            background-color: white;
            border-radius: 0.35rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }
        
        .form-control {
            width: 100%;
            padding: 0.7rem;
            border-radius: 0.35rem;
            border: 1px solid #d1d3e2;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            border-color: #4e73df;
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin-right: -0.5rem;
            margin-left: -0.5rem;
        }
        
        .form-col {
            flex: 1;
            padding: 0 0.5rem;
            min-width: 200px;
        }
        
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        
        .items-table th,
        .items-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e3e6f0;
        }
        
        .items-table th {
            font-weight: 600;
            background-color: #f8f9fc;
        }
        
        .btn-group {
            display: flex;
            justify-content: flex-end;
            margin-top: 1.5rem;
            gap: 0.5rem;
        }
        
        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: 0.35rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: #4e73df;
            color: white;
        }
        
        .btn-secondary {
            background-color: #858796;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
        }
        
        .add-item-btn {
            background-color: #1cc88a;
            color: white;
            padding: 0.4rem 1rem;
            border-radius: 0.25rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 1rem;
        }
        
        .add-item-btn:hover {
            background-color: #17a673;
        }
        
        .remove-item-btn {
            color: #e74a3b;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .remove-item-btn:hover {
            color: #be3025;
        }
        
        .total-amount {
            font-size: 1.2rem;
            font-weight: 600;
            text-align: right;
            margin-top: 1rem;
            color: var(--dark);
        }

        .budget-info {
            background-color: #f8f9fc;
            border-radius: 0.35rem;
            padding: 1rem;
            margin-top: 1rem;
            border-left: 4px solid #4e73df;
        }

        .budget-info p {
            margin: 0.5rem 0;
            font-size: 0.9rem;
        }

        .budget-info .budget-status {
            font-weight: 600;
            color: #1cc88a;
        }

        .budget-info .budget-status.warning {
            color: #f6c23e;
        }

        .budget-info .budget-status.danger {
            color: #e74a3b;
        }
        
        /* สไตล์สำหรับป๊อปอัพการแจ้งเตือน */
        .alert-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            background-color: #1cc88a;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateX(200%);
            transition: transform 0.3s ease-in-out;
            z-index: 9999;
        }

        .alert-popup.show {
            transform: translateX(0);
        }

        .alert-popup.error {
            background-color: #e74a3b;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="brand">
            <i class="fas fa-shopping-cart"></i>
            <h1>ฝ่ายจัดซื้อ</h1>
        </div>
        <nav>
            <ul>
                <li><a href="procurement-dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li class="active"><a href="#"><i class="fas fa-file-alt"></i> จัดทำใบขอซื้อ</a></li>
                <li><a href="purchase-order.html"><i class="fas fa-file-invoice"></i> จัดทำใบสั่งซื้อ</a></li>
                <li><a href="vendor-management.html"><i class="fas fa-store"></i> จัดการผู้ขาย</a></li>
                <li><a href="inventory.html"><i class="fas fa-boxes"></i> จัดการสินค้าคงคลัง</a></li>
            </ul>
        </nav>
    </div>
    
    <div class="main-content">
        <header>
            <div class="search-bar">
                <input type="text" placeholder="ค้นหา...">
                <i class="fas fa-search"></i>
            </div>
            <div class="user-profile">
                <span id="username-display"></span>
                <div class="avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <button id="logout-btn"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>
        
        <div class="content">
            <h2>จัดทำใบขอซื้อ (Purchase Requisition)</h2>
            
            <div class="form-container">
                <form id="pr-form">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">เลขที่ใบขอซื้อ</label>
                                <input type="text" class="form-control" id="pr-number" value="PR-2024-XXXX" readonly>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">วันที่</label>
                                <input type="date" class="form-control" id="pr-date" value="">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">แผนก</label>
                                <select class="form-control" id="department">
                                    <option value="procurement">ฝ่ายจัดซื้อ</option>
                                    <option value="finance">ฝ่ายการเงิน</option>
                                    <option value="it">ฝ่ายไอที</option>
                                    <option value="hr">ฝ่ายทรัพยากรบุคคล</option>
                                    <option value="marketing">ฝ่ายการตลาด</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">หัวข้อ/วัตถุประสงค์</label>
                        <input type="text" class="form-control" id="pr-title" placeholder="ระบุหัวข้อหรือวัตถุประสงค์ของการขอซื้อ">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">คำอธิบาย</label>
                        <textarea class="form-control" id="pr-description" rows="3" placeholder="รายละเอียดเพิ่มเติม"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">รายการสินค้า</label>
                        <button type="button" class="add-item-btn" id="add-item-btn">
                            <i class="fas fa-plus"></i> เพิ่มรายการ
                        </button>
                        
                        <table class="items-table" id="items-table">
                            <thead>
                                <tr>
                                    <th width="40%">รายการ</th>
                                    <th width="10%">จำนวน</th>
                                    <th width="15%">หน่วย</th>
                                    <th width="15%">ราคาต่อหน่วย (บาท)</th>
                                    <th width="15%">รวม (บาท)</th>
                                    <th width="5%"></th>
                                </tr>
                            </thead>
                            <tbody id="items-body">
                                <tr class="item-row">
                                    <td><input type="text" class="form-control item-name" placeholder="ชื่อสินค้า"></td>
                                    <td><input type="number" class="form-control item-quantity" value="1" min="1"></td>
                                    <td>
                                        <select class="form-control item-unit">
                                            <option value="ชิ้น">ชิ้น</option>
                                            <option value="อัน">อัน</option>
                                            <option value="ชุด">ชุด</option>
                                            <option value="กล่อง">กล่อง</option>
                                            <option value="รีม">รีม</option>
                                            <option value="แพ็ค">แพ็ค</option>
                                        </select>
                                    </td>
                                    <td><input type="number" class="form-control item-price" value="0" min="0"></td>
                                    <td><input type="text" class="form-control item-total" value="0" readonly></td>
                                    <td>
                                        <button type="button" class="remove-item-btn">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="total-amount">
                        ยอดรวมทั้งสิ้น: <span id="grand-total">0.00</span> บาท
                    </div>
                    
                    <div class="budget-info" id="budget-info">
                        <p><strong>ข้อมูลงบประมาณ:</strong></p>
                        <p>งบประมาณคงเหลือ: <span id="remaining-budget">2,000,000.00</span> บาท</p>
                        <p>สถานะ: <span id="budget-status" class="budget-status">เพียงพอ</span></p>
                    </div>

                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" id="cancel-btn">ยกเลิก</button>
                        <button type="button" class="btn btn-primary" id="save-btn">บันทึก</button>
                        <button type="button" class="btn btn-primary" id="submit-btn">ส่งอนุมัติ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- ป๊อปอัพการแจ้งเตือน -->
    <div class="alert-popup" id="alert-popup"></div>

    <script src="dashboard.js"></script>
    <script src="auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ตรวจสอบว่าผู้ใช้มี role_id = 3 (Procurement)
            const roleId = localStorage.getItem('role_id') || sessionStorage.getItem('role_id');
            if (roleId != 3) {
                // ถ้าเข้าถึงหน้านี้ด้วย role ที่ไม่ใช่ Procurement ให้แสดงข้อความเตือน
                alert('คุณไม่มีสิทธิ์เข้าถึงหน้านี้');
                // และ redirect ไปยังหน้าที่เหมาะสมตาม role
                redirectBasedOnRole(roleId);
                return;
            }
            
            // กำหนดวันที่ปัจจุบัน
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0]; // รูปแบบ YYYY-MM-DD
            document.getElementById('pr-date').value = formattedDate;
            
            // สร้างเลขที่ใบขอซื้อ
            const prNumber = 'PR-' + today.getFullYear() + '-' + Math.floor(1000 + Math.random() * 9000);
            document.getElementById('pr-number').value = prNumber;
            
            // เพิ่มรายการสินค้า
            document.getElementById('add-item-btn').addEventListener('click', function() {
                const itemsBody = document.getElementById('items-body');
                const newRow = document.createElement('tr');
                newRow.className = 'item-row';
                
                newRow.innerHTML = `
                    <td><input type="text" class="form-control item-name" placeholder="ชื่อสินค้า"></td>
                    <td><input type="number" class="form-control item-quantity" value="1" min="1"></td>
                    <td>
                        <select class="form-control item-unit">
                            <option value="ชิ้น">ชิ้น</option>
                            <option value="อัน">อัน</option>
                            <option value="ชุด">ชุด</option>
                            <option value="กล่อง">กล่อง</option>
                            <option value="รีม">รีม</option>
                            <option value="แพ็ค">แพ็ค</option>
                        </select>
                    </td>
                    <td><input type="number" class="form-control item-price" value="0" min="0"></td>
                    <td><input type="text" class="form-control item-total" value="0" readonly></td>
                    <td>
                        <button type="button" class="remove-item-btn">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                `;
                
                itemsBody.appendChild(newRow);
                
                // เพิ่ม event listeners สำหรับแถวใหม่
                addItemEventListeners(newRow);
            });
            
            // เพิ่ม event listeners สำหรับแถวแรก
            const firstRow = document.querySelector('.item-row');
            addItemEventListeners(firstRow);
            
            // ฟังก์ชันเพิ่ม event listeners สำหรับแถวรายการสินค้า
            function addItemEventListeners(row) {
                const quantityInput = row.querySelector('.item-quantity');
                const priceInput = row.querySelector('.item-price');
                const totalInput = row.querySelector('.item-total');
                const removeBtn = row.querySelector('.remove-item-btn');
                
                // คำนวณราคารวม
                function calculateTotal() {
                    const quantity = parseFloat(quantityInput.value) || 0;
                    const price = parseFloat(priceInput.value) || 0;
                    const total = quantity * price;
                    totalInput.value = total.toFixed(2);
                    
                    // คำนวณยอดรวมทั้งหมด
                    calculateGrandTotal();
                }
                
                // เพิ่ม event listeners
                quantityInput.addEventListener('input', calculateTotal);
                priceInput.addEventListener('input', calculateTotal);
                
                // ลบรายการ
                removeBtn.addEventListener('click', function() {
                    if (document.querySelectorAll('.item-row').length > 1) {
                        row.remove();
                        calculateGrandTotal();
                    } else {
                        showAlert('ไม่สามารถลบรายการสุดท้ายได้', 'error');
                    }
                });
            }
            
            // คำนวณยอดรวมทั้งหมด
            function calculateGrandTotal() {
                const totalInputs = document.querySelectorAll('.item-total');
                let grandTotal = 0;
                
                totalInputs.forEach(input => {
                    grandTotal += parseFloat(input.value) || 0;
                });
                
                document.getElementById('grand-total').textContent = grandTotal.toFixed(2);
                
                // ตรวจสอบงบประมาณ
                checkBudget(grandTotal);
            }
            
            // ตรวจสอบงบประมาณ
            function checkBudget(amount) {
                const budgetRemaining = parseFloat(document.getElementById('remaining-budget').textContent.replace(/,/g, '')) || 0;
                const budgetStatus = document.getElementById('budget-status');
                
                if (amount > budgetRemaining) {
                    budgetStatus.textContent = 'ไม่เพียงพอ';
                    budgetStatus.className = 'budget-status danger';
                } else if (amount > budgetRemaining * 0.8) {
                    budgetStatus.textContent = 'ใกล้หมด';
                    budgetStatus.className = 'budget-status warning';
                } else {
                    budgetStatus.textContent = 'เพียงพอ';
                    budgetStatus.className = 'budget-status';
                }
            }
            
            // แสดงการแจ้งเตือน
            function showAlert(message, type = '') {
                const alertPopup = document.getElementById('alert-popup');
                alertPopup.textContent = message;
                alertPopup.className = 'alert-popup' + (type ? ' ' + type : '');
                alertPopup.classList.add('show');
                
                setTimeout(() => {
                    alertPopup.classList.remove('show');
                }, 3000);
            }
            
            // บันทึกใบขอซื้อ
            document.getElementById('save-btn').addEventListener('click', function() {
                // ตรวจสอบข้อมูล
                if (!validateForm()) {
                    return;
                }
                
                // เก็บข้อมูลใบขอซื้อ
                const prData = collectFormData();
                
                // จำลองการบันทึกข้อมูล
                savePurchaseRequisition(prData, 'draft');
            });
            
            // ส่งใบขอซื้อเพื่ออนุมัติ
            document.getElementById('submit-btn').addEventListener('click', function() {
                // ตรวจสอบข้อมูล
                if (!validateForm()) {
                    return;
                }
                
                // เก็บข้อมูลใบขอซื้อ
                const prData = collectFormData();
                
                // ตรวจสอบงบประมาณก่อนส่งอนุมัติ
                const grandTotal = parseFloat(document.getElementById('grand-total').textContent) || 0;
                const budgetRemaining = parseFloat(document.getElementById('remaining-budget').textContent.replace(/,/g, '')) || 0;
                
                if (grandTotal > budgetRemaining) {
                    if (!confirm('ยอดรวมเกินงบประมาณที่มีอยู่ ยืนยันที่จะส่งอนุมัติหรือไม่?')) {
                        return;
                    }
                }
                
                // จำลองการบันทึกและส่งอนุมัติ
                savePurchaseRequisition(prData, 'pending');
            });
            
            // ยกเลิกการทำรายการ
            document.getElementById('cancel-btn').addEventListener('click', function() {
                if (confirm('ยืนยันการยกเลิกการทำรายการ?')) {
                    window.location.href = 'procurement-dashboard.html';
                }
            });
            
            // ตรวจสอบความถูกต้องของข้อมูล
            function validateForm() {
                const title = document.getElementById('pr-title').value.trim();
                const itemRows = document.querySelectorAll('.item-row');
                let isValid = true;
                
                // ตรวจสอบหัวข้อ
                if (!title) {
                    showAlert('กรุณาระบุหัวข้อ/วัตถุประสงค์', 'error');
                    document.getElementById('pr-title').focus();
                    return false;
                }
                
                // ตรวจสอบรายการสินค้า
                let hasItems = false;
                
                itemRows.forEach(row => {
                    const nameInput = row.querySelector('.item-name');
                    const quantityInput = row.querySelector('.item-quantity');
                    const priceInput = row.querySelector('.item-price');
                    
                    const name = nameInput.value.trim();
                    const quantity = parseFloat(quantityInput.value) || 0;
                    const price = parseFloat(priceInput.value) || 0;
                    
                    if (name || quantity > 0 || price > 0) {
                        hasItems = true;
                        
                        // ตรวจสอบความถูกต้องของแต่ละรายการ
                        if (!name) {
                            isValid = false;
                            nameInput.style.borderColor = '#e74a3b';
                        } else {
                            nameInput.style.borderColor = '#d1d3e2';
                        }
                        
                        if (quantity <= 0) {
                            isValid = false;
                            quantityInput.style.borderColor = '#e74a3b';
                        } else {
                            quantityInput.style.borderColor = '#d1d3e2';
                        }
                        
                        if (price <= 0) {
                            isValid = false;
                            priceInput.style.borderColor = '#e74a3b';
                        } else {
                            priceInput.style.borderColor = '#d1d3e2';
                        }
                    }
                });
                
                if (!hasItems) {
                    showAlert('กรุณาเพิ่มอย่างน้อย 1 รายการ', 'error');
                    return false;
                }
                
                if (!isValid) {
                    showAlert('กรุณาตรวจสอบข้อมูลในรายการสินค้า', 'error');
                    return false;
                }
                
                return true;
            }
            
            // เก็บข้อมูลจากฟอร์ม
            function collectFormData() {
                const prNumber = document.getElementById('pr-number').value;
                const prDate = document.getElementById('pr-date').value;
                const department = document.getElementById('department').value;
                const title = document.getElementById('pr-title').value.trim();
                const description = document.getElementById('pr-description').value.trim();
                
                const items = [];
                const itemRows = document.querySelectorAll('.item-row');
                
                itemRows.forEach(row => {
                    const name = row.querySelector('.item-name').value.trim();
                    const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                    const unit = row.querySelector('.item-unit').value;
                    const price = parseFloat(row.querySelector('.item-price').value) || 0;
                    const total = parseFloat(row.querySelector('.item-total').value) || 0;
                    
                    if (name && quantity > 0 && price > 0) {
                        items.push({
                            name,
                            quantity,
                            unit,
                            price,
                            total
                        });
                    }
                });
                
                const grandTotal = parseFloat(document.getElementById('grand-total').textContent) || 0;
                
                return {
                    prNumber,
                    prDate,
                    department,
                    title,
                    description,
                    items,
                    grandTotal,
                    createdBy: localStorage.getItem('username') || sessionStorage.getItem('username')
                };
            }
            
            // จำลองการบันทึกข้อมูลใบขอซื้อ
            async function savePurchaseRequisition(prData, status) {
                try {
                    // เตรียมข้อมูลสำหรับส่งไปยัง API
                    const requestData = {
                        ...prData,
                        status: status
                    };
                    
                    // ในระบบจริงจะส่งข้อมูลไปยัง API
                    console.log('บันทึกใบขอซื้อ:', requestData);
                    
                    // จำลองการส่งข้อมูลไปยัง API
                    if (window.procurementFunctions && window.procurementFunctions.createNewRequisition) {
                        const result = await window.procurementFunctions.createNewRequisition(requestData);
                        console.log('ผลลัพธ์:', result);
                        
                        showAlert('บันทึกใบขอซื้อสำเร็จ' + (status === 'pending' ? ' และส่งไปอนุมัติเรียบร้อยแล้ว' : ''));
                        
                        // รอสักครู่ก่อนที่จะ redirect
                        setTimeout(() => {
                            window.location.href = 'procurement-dashboard.html';
                        }, 2000);
                    } else {
                        // กรณีไม่สามารถเรียกใช้ฟังก์ชันได้ ให้ใช้ตัวอย่างการจำลอง
                        setTimeout(() => {
                            showAlert('บันทึกใบขอซื้อสำเร็จ' + (status === 'pending' ? ' และส่งไปอนุมัติเรียบร้อยแล้ว' : ''));
                            
                            // รอสักครู่ก่อนที่จะ redirect
                            setTimeout(() => {
                                window.location.href = 'procurement-dashboard.html';
                            }, 2000);
                        }, 1000);
                    }
                } catch (error) {
                    console.error('เกิดข้อผิดพลาดในการบันทึกใบขอซื้อ:', error);
                    showAlert('เกิดข้อผิดพลาดในการบันทึกใบขอซื้อ', 'error');
                }
            }
        });
    </script>
</body>
</html>